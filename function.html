<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Waste Tracking System | EcoWaste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- Using a different CDN for html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #10b981;
            --secondary: #3b82f6;
            --accent: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            min-height: 100vh;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .category-recyclable {
            border-left: 4px solid var(--primary);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.2) 100%);
        }
        
        .category-reusable {
            border-left: 4px solid var(--accent);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.2) 100%);
        }
        
        .category-hazardous {
            border-left: 4px solid var(--danger);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.2) 100%);
        }
        
        .qr-scanner {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
            min-height: 300px;
            position: relative;
        }
        
        .qr-scanner:hover {
            border-color: var(--primary);
            background-color: rgba(16, 185, 129, 0.05);
        }
        
        #reader {
            width: 100%;
            height: 100%;
            min-height: 250px;
        }
        
        .scanner-active {
            border-color: var(--primary);
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .scanner-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 250px;
            color: #6b7280;
        }
        
        .item-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-processing { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-disposed { background-color: #fce7f3; color: #9d174d; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .qr-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6b7280;
        }
        
        .qr-error {
            color: #ef4444;
            text-align: center;
            padding: 1rem;
        }
        
        .camera-permission {
            text-align: center;
            padding: 1rem;
            color: #ef4444;
            font-size: 0.9rem;
        }
        
        .library-error {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-recycle text-2xl text-green-500 mr-2"></i>
                        <span class="text-xl font-bold text-gray-800">EcoWaste Tracker</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i> New Item
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">E-Waste Tracking System</h1>
            
            <!-- Library Error Message (hidden by default) -->
            <div id="library-error" class="library-error hidden">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="library-error-message">QR scanner library failed to load. Some features may not work.</span>
            </div>
            
            <div class="grid lg:grid-cols-2 gap-8 mb-12">
                <!-- QR Scanner Section -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold mb-6">QR Code Scanner</h2>
                    <div class="qr-scanner rounded-lg p-6 text-center mb-6" id="scanner-container">
                        <div id="reader" class="mb-4">
                            <div class="scanner-placeholder">
                                <i class="fas fa-camera text-4xl mb-3"></i>
                                <p>Camera scanner will appear here</p>
                                <p class="text-sm text-gray-500 mt-2">Click "Start Scanner" to begin</p>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-4">Scan QR code to track e-waste item</p>
                        <div class="flex gap-2 justify-center">
                            <button id="start-scanner" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-play mr-1"></i>Start Scanner
                            </button>
                            <button id="stop-scanner" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg" disabled>
                                <i class="fas fa-stop mr-1"></i>Stop Scanner
                            </button>
                        </div>
                        <div id="camera-permission-message" class="camera-permission hidden">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Camera permission required. Please allow camera access.
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Scanning Instructions:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>Ensure good lighting for better scanning</li>
                            <li>Position QR code within the scanner frame</li>
                            <li>Each scan retrieves item details instantly</li>
                            <li>Track recycling progress in real-time</li>
                        </ul>
                    </div>
                </div>

                <!-- Add New Item Form -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold mb-6">Register New E-Waste Item</h2>
                    <form id="item-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Item Type *</label>
                            <select id="item-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                                <option value="">Select item type</option>
                                <option value="computer">Computer/Laptop</option>
                                <option value="mobile">Mobile Phone</option>
                                <option value="monitor">Monitor</option>
                                <option value="battery">Battery</option>
                                <option value="printer">Printer</option>
                                <option value="projector">Projector</option>
                                <option value="lab">Lab Equipment</option>
                                <option value="other">Other Electronic</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                            <div class="grid grid-cols-3 gap-2" id="category-buttons">
                                <button type="button" data-category="recyclable" class="category-recyclable px-4 py-2 rounded-lg text-sm font-medium">Recyclable</button>
                                <button type="button" data-category="reusable" class="category-reusable px-4 py-2 rounded-lg text-sm font-medium">Reusable</button>
                                <button type="button" data-category="hazardous" class="category-hazardous px-4 py-2 rounded-lg text-sm font-medium">Hazardous</button>
                            </div>
                            <input type="hidden" id="category" name="category" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Location Details *</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input type="text" id="building" class="px-4 py-2 border border-gray-300 rounded-lg" placeholder="Building" required>
                                <input type="text" id="floor" class="px-4 py-2 border border-gray-300 rounded-lg" placeholder="Floor" required>
                            </div>
                            <input type="text" id="room" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Room Number" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Item Condition</label>
                            <select id="condition" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                                <option value="broken">Broken/Damaged</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="description" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" rows="3" placeholder="Additional details about the item (brand, model, specifications...)"></textarea>
                        </div>
                        
                        <div class="flex gap-2">
                            <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                                <i class="fas fa-qrcode mr-2"></i>Generate QR Code
                            </button>
                            <button type="button" id="save-item" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Item
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Items List -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Tracked E-Waste Items</h2>
                    <div class="flex gap-2">
                        <select id="filter-category" class="px-3 py-1 border border-gray-300 rounded-lg">
                            <option value="">All Categories</option>
                            <option value="recyclable">Recyclable</option>
                            <option value="reusable">Reusable</option>
                            <option value="hazardous">Hazardous</option>
                        </select>
                        <select id="filter-status" class="px-3 py-1 border border-gray-300 rounded-lg">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="disposed">Disposed</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="items-container">
                    <!-- Items will be dynamically added here -->
                </div>
            </div>
        </div>
    </main>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <h3 class="text-xl font-semibold mb-4">Generated QR Code</h3>
                <div id="qrcode" class="mb-4">
                    <div class="qr-loading">
                        <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                        <p>Generating QR code...</p>
                    </div>
                </div>
                <div id="qr-data" class="bg-gray-100 p-3 rounded-lg text-sm font-mono mb-4 hidden">
                    <p>QR Data Preview:</p>
                    <p id="qr-data-content" class="text-xs break-all"></p>
                </div>
                <p class="text-sm text-gray-600 mb-4">Scan this code to track this e-waste item</p>
                <button id="download-qr" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg mr-2">
                    <i class="fas fa-download mr-1"></i>Download
                </button>
                <button id="close-modal" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Item Details Modal -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Item Details</h3>
            <div id="item-details" class="space-y-3">
                <!-- Item details will be populated here -->
            </div>
            <div class="mt-6 flex gap-2">
                <button id="close-item-modal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">
                    Close
                </button>
                <button id="update-status" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                    Update Status
                </button>
            </div>
        </div>
    </div>

    <script>
        // Sample data storage (in real application, this would be a database)
        let eWasteItems = JSON.parse(localStorage.getItem('eWasteItems')) || [];
        let currentItemId = parseInt(localStorage.getItem('currentItemId')) || 1;
        let html5QrcodeScanner = null;
        let currentQRData = null;
        let isScannerActive = false;
        let isLibraryLoaded = false;

        // Check if HTML5 QR code library is loaded
        function checkLibraryLoaded() {
            if (typeof Html5Qrcode !== 'undefined' && typeof Html5QrcodeScanner !== 'undefined') {
                isLibraryLoaded = true;
                document.getElementById('library-error').classList.add('hidden');
                return true;
            } else {
                isLibraryLoaded = false;
                document.getElementById('library-error').classList.remove('hidden');
                document.getElementById('library-error-message').textContent = 
                    'QR scanner library failed to load. Camera scanning will not work. Please check your internet connection.';
                document.getElementById('start-scanner').disabled = true;
                document.getElementById('start-scanner').innerHTML = '<i class="fas fa-ban mr-1"></i>Scanner Unavailable';
                return false;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if library loaded properly
            setTimeout(() => {
                checkLibraryLoaded();
            }, 1000); // Give it a second to load

            initializeCategoryButtons();
            initializeForm();
            initializeScanner();
            loadItems();
            setupEventListeners();
            
            // Load initial sample data if empty
            if (eWasteItems.length === 0) {
                loadSampleData();
            }
        });

        function initializeCategoryButtons() {
            const buttons = document.querySelectorAll('#category-buttons button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    buttons.forEach(b => b.classList.remove('ring-2', 'ring-offset-2'));
                    this.classList.add('ring-2', 'ring-offset-2');
                    document.getElementById('category').value = this.dataset.category;
                });
            });
        }

        function initializeForm() {
            const form = document.getElementById('item-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                generateQRCode();
            });

            document.getElementById('save-item').addEventListener('click', function() {
                saveEWasteItem();
            });
        }

        function initializeScanner() {
            document.getElementById('start-scanner').addEventListener('click', startScanner);
            document.getElementById('stop-scanner').addEventListener('click', stopScanner);
        }

        function setupEventListeners() {
            // Filter functionality
            document.getElementById('filter-category').addEventListener('change', filterItems);
            document.getElementById('filter-status').addEventListener('change', filterItems);
            
            // Modal functionality
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('close-item-modal').addEventListener('click', closeItemModal);
            document.getElementById('update-status').addEventListener('click', updateItemStatus);
            document.getElementById('download-qr').addEventListener('click', downloadQRCode);
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    closeModal();
                    closeItemModal();
                }
            });
        }

        function loadSampleData() {
            eWasteItems = [
                {
                    id: 1,
                    type: 'computer',
                    category: 'recyclable',
                    building: 'Main Building',
                    floor: '3',
                    room: '301',
                    condition: 'fair',
                    description: 'Dell Optiplex 3020, 8GB RAM, 500GB HDD',
                    status: 'processing',
                    dateAdded: '2024-01-15',
                    qrCode: 'EW-0001'
                },
                {
                    id: 2,
                    type: 'mobile',
                    category: 'reusable',
                    building: 'Campus Center',
                    floor: '1',
                    room: 'Reception',
                    condition: 'good',
                    description: 'Samsung Galaxy S10, fully functional',
                    status: 'pending',
                    dateAdded: '2024-01-14',
                    qrCode: 'EW-0002'
                },
                {
                    id: 3,
                    type: 'battery',
                    category: 'hazardous',
                    building: 'Lab Building',
                    floor: '2',
                    room: 'Lab 201',
                    condition: 'poor',
                    description: 'Lithium-ion batteries from lab equipment',
                    status: 'completed',
                    dateAdded: '2024-01-13',
                    qrCode: 'EW-0003'
                }
            ];
            localStorage.setItem('eWasteItems', JSON.stringify(eWasteItems));
            localStorage.setItem('currentItemId', '4');
            loadItems();
        }

        async function startScanner() {
            if (isScannerActive) {
                return;
            }

            // Check if library is loaded
            if (!checkLibraryLoaded()) {
                alert('QR scanner library not loaded. Please check your internet connection and refresh the page.');
                return;
            }

            try {
                // Check if camera permission is already granted
                const cameras = await Html5Qrcode.getCameras();
                if (!cameras || cameras.length === 0) {
                    showCameraPermissionMessage('No cameras found. Please check your device.');
                    return;
                }

                // Create scanner instance
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader",
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    false
                );
                
                // Start scanning
                html5QrcodeScanner.render(
                    (decodedText, decodedResult) => {
                        handleScannedCode(decodedText);
                    },
                    (errorMessage) => {
                        // Ignore scanning errors
                    }
                );

                // Update UI for active scanner
                isScannerActive = true;
                document.getElementById('start-scanner').disabled = true;
                document.getElementById('stop-scanner').disabled = false;
                document.getElementById('scanner-container').classList.add('scanner-active');
                document.getElementById('camera-permission-message').classList.add('hidden');

            } catch (error) {
                console.error('Scanner error:', error);
                
                if (error.name === 'NotAllowedError') {
                    showCameraPermissionMessage('Camera access denied. Please allow camera permission in your browser settings.');
                } else if (error.name === 'NotFoundError') {
                    showCameraPermissionMessage('No camera found on this device.');
                } else if (error.name === 'NotSupportedError') {
                    showCameraPermissionMessage('Camera not supported in this browser.');
                } else {
                    showCameraPermissionMessage('Error starting camera: ' + error.message);
                }
                
                // Reset scanner state
                isScannerActive = false;
                document.getElementById('start-scanner').disabled = false;
                document.getElementById('stop-scanner').disabled = true;
            }
        }

        function showCameraPermissionMessage(message) {
            const messageElement = document.getElementById('camera-permission-message');
            messageElement.textContent = message;
            messageElement.classList.remove('hidden');
        }

        async function stopScanner() {
            if (!html5QrcodeScanner || !isScannerActive) {
                return;
            }

            try {
                // Use clear() method instead of stop() for Html5QrcodeScanner
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
                isScannerActive = false;
                
                // Update UI
                document.getElementById('start-scanner').disabled = false;
                document.getElementById('stop-scanner').disabled = true;
                document.getElementById('scanner-container').classList.remove('scanner-active');
                
                // Clear scanner view
                const readerElement = document.getElementById('reader');
                readerElement.innerHTML = '<div class="scanner-placeholder"><i class="fas fa-camera text-4xl mb-3"></i><p>Camera scanner stopped</p><p class="text-sm text-gray-500 mt-2">Click "Start Scanner" to begin again</p></div>';
                
            } catch (error) {
                console.error('Error stopping scanner:', error);
            }
        }

        function handleScannedCode(qrData) {
            try {
                const itemData = JSON.parse(qrData);
                const item = eWasteItems.find(i => i.id === itemData.id);
                
                if (item) {
                    showItemDetails(item);
                    stopScanner();
                } else {
                    alert('Item not found in database. QR Code: ' + qrData);
                }
            } catch (error) {
                alert('Invalid QR code format. Scanned data: ' + qrData);
            }
        }

        function generateQRCode() {
            const formData = getFormData();
            if (!formData.category) {
                alert('Please select a category');
                return;
            }

            const itemData = {
                id: currentItemId,
                ...formData,
                status: 'pending',
                dateAdded: new Date().toISOString().split('T')[0],
                qrCode: `EW-${currentItemId.toString().padStart(4, '0')}`
            };

            currentQRData = JSON.stringify(itemData);
            
            // Show loading state
            document.getElementById('qrcode').innerHTML = `
                <div class="qr-loading">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>Generating QR code...</p>
                </div>
            `;
            
            // Show modal first
            document.getElementById('qr-modal').style.display = 'block';
            
            // Show QR data preview
            document.getElementById('qr-data-content').textContent = currentQRData;
            document.getElementById('qr-data').classList.remove('hidden');

            // Generate QR code with better error handling
            try {
                // Clear previous QR code
                const qrContainer = document.getElementById('qrcode');
                
                // Use QRCode.toString to get SVG first, then convert to image
                QRCode.toString(currentQRData, {
                    type: 'svg',
                    width: 200,
                    margin: 1,
                    color: {
                        dark: '#10b981',
                        light: '#ffffff'
                    }
                }, function(error, svgString) {
                    if (error) {
                        console.error('QR code generation error:', error);
                        showQRCodeError('Failed to generate QR code: ' + error.message);
                        return;
                    }
                    
                    // Convert SVG string to data URL
                    const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
                    const url = URL.createObjectURL(svgBlob);
                    
                    // Create image element
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = 'QR Code for E-Waste Item';
                    img.className = 'mx-auto';
                    img.onload = function() {
                        URL.revokeObjectURL(url);
                    };
                    
                    // Replace loading with image
                    qrContainer.innerHTML = '';
                    qrContainer.appendChild(img);
                });
            } catch (error) {
                console.error('QR code generation failed:', error);
                showQRCodeError('QR code generation failed. Please try again.');
            }
        }

        function showQRCodeError(message) {
            document.getElementById('qrcode').innerHTML = `
                <div class="qr-error">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        function downloadQRCode() {
            if (!currentQRData) return;
            
            const qrContainer = document.getElementById('qrcode');
            const img = qrContainer.querySelector('img');
            
            if (img) {
                const link = document.createElement('a');
                link.download = `ewaste-qr-${currentItemId}.png`;
                link.href = img.src;
                link.click();
            } else {
                alert('Please generate a QR code first');
            }
        }

        function saveEWasteItem() {
            const formData = getFormData();
            if (!formData.category) {
                alert('Please select a category');
                return;
            }

            const newItem = {
                id: currentItemId,
                ...formData,
                status: 'pending',
                dateAdded: new Date().toISOString().split('T')[0],
                qrCode: `EW-${currentItemId.toString().padStart(4, '0')}`
            };

            eWasteItems.push(newItem);
            currentItemId++;
            
            // Save to localStorage
            localStorage.setItem('eWasteItems', JSON.stringify(eWasteItems));
            localStorage.setItem('currentItemId', currentItemId.toString());
            
            // Reload items
            loadItems();
            
            // Reset form
            document.getElementById('item-form').reset();
            document.querySelectorAll('#category-buttons button').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
            });
            
            alert('Item saved successfully!');
        }

        function getFormData() {
            return {
                type: document.getElementById('item-type').value,
                category: document.getElementById('category').value,
                building: document.getElementById('building').value,
                floor: document.getElementById('floor').value,
                room: document.getElementById('room').value,
                condition: document.getElementById('condition').value,
                description: document.getElementById('description').value
            };
        }

        function loadItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            const categoryFilter = document.getElementById('filter-category').value;
            const statusFilter = document.getElementById('filter-status').value;

            const filteredItems = eWasteItems.filter(item => {
                return (!categoryFilter || item.category === categoryFilter) &&
                       (!statusFilter || item.status === statusFilter);
            });

            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>No items found. Add your first e-waste item to get started.</p>
                    </div>
                `;
                return;
            }

            filteredItems.forEach(item => {
                const card = createItemCard(item);
                container.appendChild(card);
            });
        }

        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'item-card bg-white border rounded-lg p-4';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <span class="font-semibold">${item.qrCode}</span>
                    <span class="status-badge status-${item.status}">${item.status}</span>
                </div>
                <div class="mb-2">
                    <span class="text-sm text-gray-600">Type:</span>
                    <span class="font-medium">${item.type}</span>
                </div>
                <div class="mb-2">
                    <span class="text-sm text-gray-600">Category:</span>
                    <span class="font-medium">${item.category}</span>
                </div>
                <div class="mb-3">
                    <span class="text-sm text-gray-600">Location:</span>
                    <span class="font-medium">${item.building}, ${item.floor}, ${item.room}</span>
                </div>
                <div class="text-xs text-gray-500">
                    Added: ${item.dateAdded}
                </div>
            `;

            card.addEventListener('click', () => showItemDetails(item));
            return card;
        }

        function showItemDetails(item) {
            const detailsContainer = document.getElementById('item-details');
            detailsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>Item ID:</strong> ${item.qrCode}</div>
                    <div><strong>Status:</strong> <span class="status-badge status-${item.status}">${item.status}</span></div>
                    <div><strong>Type:</strong> ${item.type}</div>
                    <div><strong>Category:</strong> ${item.category}</div>
                    <div><strong>Condition:</strong> ${item.condition}</div>
                    <div><strong>Date Added:</strong> ${item.dateAdded}</div>
                </div>
                <div class="pt-4">
                    <strong>Location:</strong> ${item.building}, Floor ${item.floor}, Room ${item.room}
                </div>
                ${item.description ? `
                <div class="pt-4">
                    <strong>Description:</strong> ${item.description}
                </div>
                ` : ''}
            `;

            document.getElementById('item-modal').style.display = 'block';
        }

        function updateItemStatus() {
            // This would typically update the item status in the database
            alert('Status update functionality would be implemented here');
        }

        function filterItems() {
            loadItems();
        }

        function closeModal() {
            document.getElementById('qr-modal').style.display = 'none';
            currentQRData = null;
        }

        function closeItemModal() {
            document.getElementById('item-modal').style.display = 'none';
        }
    </script>
</body>
</html>
